<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¼ì´ì–´ ê²Œì„</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;900&family=Black+Han+Sans&display=swap"
    rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>

  <!-- Particles -->
  <div class="floating-particles" id="particles"></div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- ====== TITLE SCREEN ====== -->
  <div class="screen active" id="titleScreen">
    <div class="title-wrap">
      <div class="game-logo">
        <div class="logo-eyebrow">ğŸ­ SOCIAL DEDUCTION</div>
        <div class="logo-title">ë¼ì´ì–´ê²Œì„</div>
        <div class="logo-sub">ê±°ì§“ë§ìŸì´ë¥¼ ì°¾ì•„ë¼</div>
      </div>

      <div class="avatar-section">
        <div class="section-label">ìºë¦­í„° ì„ íƒ</div>
        <div class="avatar-preview">
          <div class="avatar-display" id="avatarDisplay">ğŸ­</div>
          <div class="avatar-info">
            <div class="avatar-name" id="avatarName">ëœë¤ ì„ íƒ</div>
            <div class="avatar-desc" id="avatarDesc">ë²„íŠ¼ì„ ëˆŒëŸ¬ ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
          </div>
        </div>
        <button class="btn-random" id="randomBtn">
          <span class="dice-icon">ğŸ²</span>
          ëœë¤ ìºë¦­í„° ì„ íƒ
        </button>
      </div>

      <div class="input-wrap">
        <input class="game-input" type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="16"
          autocomplete="off">
        <div class="input-hint"><span id="nicknameCount">0</span>/16</div>
      </div>

      <div style="width:100%; display:flex; flex-direction:column; gap:0.6rem;">
        <button class="btn-primary" id="createRoomBtn">ìƒˆ ë°© ë§Œë“¤ê¸°</button>
        <div style="text-align:center; color:var(--text-muted); font-size:0.8rem; position:relative;">
          <span style="background:var(--bg); padding:0 0.8rem; position:relative; z-index:1;">ë˜ëŠ”</span>
          <div style="position:absolute; top:50%; left:0; right:0; height:1px; background:var(--border);"></div>
        </div>
        <div style="display:flex; gap:0.6rem;">
          <input class="game-input" type="text" id="roomCodeInput" placeholder="ë°© ì½”ë“œ ì…ë ¥" maxlength="8"
            style="text-transform:uppercase; letter-spacing:0.15em; flex:1;">
          <button class="btn-secondary" id="joinRoomBtn" style="white-space:nowrap;">ì°¸ê°€</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== LOBBY SCREEN ====== -->
  <div class="screen" id="lobbyScreen">
    <div class="lobby-wrap">
      <div class="lobby-header">
        <div class="lobby-title">ğŸ  ëŒ€ê¸°ì‹¤</div>
        <div class="room-id-badge" id="roomIdBadge">ROOM-####</div>
      </div>

      <div class="invite-bar">
        <div class="invite-url" id="inviteUrl">https://...</div>
        <button class="btn-copy" id="copyBtn">ğŸ”— ì´ˆëŒ€ ë§í¬ ë³µì‚¬</button>
      </div>

      <div>
        <div class="section-label" style="margin-bottom:0.8rem;">ì°¸ê°€ì <span id="playerCountDisplay">0</span>/8</div>
        <div class="players-grid" id="playersGrid"></div>
      </div>

      <div class="lobby-actions">
        <button class="btn-primary" id="startGameBtn" style="display:none;">ê²Œì„ ì‹œì‘ ğŸ®</button>
        <div class="waiting-text" id="waitingText">ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•˜ê¸¸ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
      </div>
    </div>
  </div>

  <!-- ====== GAME SCREEN ====== -->
  <div class="screen" id="gameScreen">
    <div class="game-layout">
      <!-- Header -->
      <div class="game-header">
        <div class="my-role-badge citizen" id="myRoleBadge">ì‹œë¯¼ ğŸ‘¤</div>
        <div class="topic-display">
          <div class="topic-category" id="topicCategory">ì¹´í…Œê³ ë¦¬</div>
          <div class="topic-word" id="topicWord" style="display:none;"></div>
          <div class="liar-unknown" id="liarUnknown" style="display:none;">???</div>
        </div>
        <div class="round-info" id="roundInfo">1ë¼ìš´ë“œ</div>
      </div>

      <!-- Chat -->
      <div class="chat-area" id="chatArea">
        <div class="system-message">ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ë¼ì´ì–´ë¥¼ ì°¾ì•„ë¼! ğŸ•µï¸</div>
      </div>

      <!-- Chat Input -->
      <div class="chat-input-area">
        <input class="chat-input" id="chatInput" placeholder="ë‚´ ì°¨ë¡€ì— ë‹¨ì–´ë¥¼ ì„¤ëª…í•˜ì„¸ìš”..." disabled>
        <button class="btn-send" id="sendBtn" disabled>â¤</button>
      </div>

      <!-- Sidebar -->
      <div class="game-sidebar">
        <div class="sidebar-card">
          <div class="sidebar-title">ë°œì–¸ ìˆœì„œ</div>
          <div class="turn-list" id="turnList"></div>
        </div>
        <div class="sidebar-card" id="hostActionsCard" style="display:none;">
          <div class="sidebar-title">ì§„í–‰</div>
          <div class="vote-actions">
            <button class="btn-vote" id="callVoteBtn">ğŸ—³ï¸ íˆ¬í‘œ ì‹œì‘</button>
            <button class="btn-skip" id="nextRoundBtn">ë‹¤ìŒ ë¼ìš´ë“œ âœ</button>
          </div>
        </div>
        <div class="sidebar-card" id="nonHostActionsCard" style="display:none;">
          <div class="sidebar-title">ì§„í–‰</div>
          <div style="font-size:0.8rem; color:var(--text-muted); text-align:center;">ë°©ì¥ì´ ë¼ìš´ë“œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== VOTING OVERLAY ====== -->
  <div class="overlay" id="votingOverlay">
    <div class="vote-modal">
      <div class="vote-header">
        <div class="vote-title">ğŸ—³ï¸ íˆ¬í‘œ</div>
        <div class="vote-subtitle">ë¼ì´ì–´ë¼ê³  ìƒê°í•˜ëŠ” í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
      </div>
      <div class="vote-timer" id="voteTimer">60</div>
      <div class="vote-progress">
        <div class="vote-progress-bar" id="voteProgressBar" style="width:100%;"></div>
      </div>
      <div class="vote-count-info" id="voteCountInfo">0ëª… íˆ¬í‘œ ì™„ë£Œ</div>
      <div class="vote-players" id="votePlayers"></div>
      <div style="text-align:center; color:var(--text-muted); font-size:0.8rem;">íˆ¬í‘œ í›„ ë³€ê²½ ë¶ˆê°€</div>
    </div>
  </div>

  <!-- ====== RESULT OVERLAY ====== -->
  <div class="overlay" id="resultOverlay">
    <div class="result-modal">
      <div class="result-outcome" id="resultOutcome">ì‹œë¯¼ ìŠ¹ë¦¬!</div>
      <div class="result-desc" id="resultDesc">ë¼ì´ì–´ë¥¼ ì°¾ì•„ëƒˆìŠµë‹ˆë‹¤.</div>
      <div class="result-liar-reveal">
        <div class="result-liar-label">ë¼ì´ì–´</div>
        <div class="result-liar-player">
          <div class="result-liar-avatar" id="resultLiarAvatar">ğŸ­</div>
          <div class="result-liar-name" id="resultLiarName">í”Œë ˆì´ì–´</div>
        </div>
        <div class="result-topic">
          ì •ë‹µ: <span class="result-topic-word" id="resultTopicWord">ë‹¨ì–´</span>
          <span style="color:var(--text-muted);"> (ì¹´í…Œê³ ë¦¬: </span><span id="resultTopicCat">-</span><span
            style="color:var(--text-muted);">)</span>
        </div>
      </div>
      <button class="btn-primary" id="returnToLobbyBtn">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const SERVER_URL = 'https://liar-game-en4n.onrender.com'; // â† ì—¬ê¸°ì— Render URL ì…ë ¥

    // ====== AVATARS ======
    const AVATARS = [
      { emoji: 'ğŸ¦Š', name: 'ì—¬ìš°', desc: 'êµí™œí•œ ì—¬ìš°' },
      { emoji: 'ğŸº', name: 'ëŠ‘ëŒ€', desc: 'ì‹ ë¹„ë¡œìš´ ëŠ‘ëŒ€' },
      { emoji: 'ğŸ¦', name: 'ì‚¬ì', desc: 'ìš©ê°í•œ ì‚¬ì' },
      { emoji: 'ğŸ¯', name: 'í˜¸ë‘ì´', desc: 'ê°•ì¸í•œ í˜¸ë‘ì´' },
      { emoji: 'ğŸ»', name: 'ê³°', desc: 'ë“¬ì§í•œ ê³°' },
      { emoji: 'ğŸ¦', name: 'ë„ˆêµ¬ë¦¬', desc: 'ì¥ë‚œìŠ¤ëŸ° ë„ˆêµ¬ë¦¬' },
      { emoji: 'ğŸ¸', name: 'ê°œêµ¬ë¦¬', desc: 'ì¾Œí™œí•œ ê°œêµ¬ë¦¬' },
      { emoji: 'ğŸ¦‰', name: 'ë¶€ì—‰ì´', desc: 'ì§€í˜œë¡œìš´ ë¶€ì—‰ì´' },
      { emoji: 'ğŸ™', name: 'ë¬¸ì–´', desc: 'ì‹ ë¹„í•œ ë¬¸ì–´' },
      { emoji: 'ğŸ¦‹', name: 'ë‚˜ë¹„', desc: 'ìš°ì•„í•œ ë‚˜ë¹„' },
      { emoji: 'ğŸ²', name: 'ë“œë˜ê³¤', desc: 'ì „ì„¤ì˜ ë“œë˜ê³¤' },
      { emoji: 'ğŸ¦„', name: 'ìœ ë‹ˆì½˜', desc: 'ë§ˆë²•ì˜ ìœ ë‹ˆì½˜' },
      { emoji: 'ğŸº', name: 'ëŠ‘ëŒ€ì¸ê°„', desc: 'ë‹¬ë¹›ì˜ ëŠ‘ëŒ€ì¸ê°„' },
      { emoji: 'ğŸ‘»', name: 'ìœ ë ¹', desc: 'ë– ë„ëŠ” ìœ ë ¹' },
      { emoji: 'ğŸ¤¡', name: 'ê´‘ëŒ€', desc: 'ì›ƒìŒì˜ ê´‘ëŒ€' },
      { emoji: 'ğŸ­', name: 'ë°°ìš°', desc: 'ì—°ê¸°ì˜ ë‹¬ì¸' },
    ];

    // ====== STATE ======
    let state = {
      socket: null,
      roomId: null,
      nickname: '',
      avatar: AVATARS[0],
      isHost: false,
      isLiar: false,
      myWord: null,
      myCategory: null,
      currentTurnPlayerId: null,
      myId: null,
      players: [],
      turnOrder: [],
      voteTimerInterval: null,
      voteTimeLeft: 60,
      myVote: null,
      round: 1,
    };

    // ====== PARTICLES ======
    function createParticles() {
      const container = document.getElementById('particles');
      for (let i = 0; i < 15; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        const size = Math.random() * 6 + 2;
        const colors = ['#e63946', '#7b2fff', '#06d6a0', '#ffd166'];
        p.style.cssText = `
      width:${size}px; height:${size}px;
      left:${Math.random() * 100}%;
      background:${colors[Math.floor(Math.random() * colors.length)]};
      animation-duration:${Math.random() * 15 + 10}s;
      animation-delay:${Math.random() * 10}s;
    `;
        container.appendChild(p);
      }
    }
    createParticles();

    // ====== SHOW SCREEN ======
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function showOverlay(id) {
      document.getElementById(id).classList.add('active');
    }

    function hideOverlay(id) {
      document.getElementById(id).classList.remove('active');
    }

    // ====== TOAST (ì—ëŸ¬ í¬í•¨) ======
    function showToast(msg, duration = 3000, isError = false) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.borderColor = isError ? 'var(--accent)' : 'var(--border)';
      t.style.color = isError ? 'var(--accent2)' : 'var(--text)';
      t.classList.add('show');
      clearTimeout(t._timer);
      t._timer = setTimeout(() => t.classList.remove('show'), duration);
    }

    // ====== ì„œë²„ ì›¨ì´í¬ì—… (Render ë¬´ë£Œ ìŠ¬ë¦½ ëŒ€ì‘) ======
    let serverReady = false;
    async function wakeUpServer() {
      try {
        const res = await fetch(`${SERVER_URL}/api/health`, { signal: AbortSignal.timeout(15000) });
        if (res.ok) { serverReady = true; return true; }
      } catch (e) { }
      return false;
    }

    // ë²„íŠ¼ ë¡œë”© ìƒíƒœ
    function setButtonLoading(btnId, loading, text) {
      const btn = document.getElementById(btnId);
      btn.disabled = loading;
      btn.innerHTML = loading
        ? `<span class="spinner"></span> ${text}`
        : text;
    }

    // ====== TITLE SCREEN ======
    let selectedAvatar = AVATARS[Math.floor(Math.random() * AVATARS.length)];

    function updateAvatarDisplay() {
      const display = document.getElementById('avatarDisplay');
      display.textContent = selectedAvatar.emoji;
      display.classList.remove('animate');
      void display.offsetWidth;
      display.classList.add('animate');
      document.getElementById('avatarName').textContent = selectedAvatar.name;
      document.getElementById('avatarDesc').textContent = selectedAvatar.desc;
    }
    updateAvatarDisplay();

    document.getElementById('randomBtn').addEventListener('click', () => {
      selectedAvatar = AVATARS[Math.floor(Math.random() * AVATARS.length)];
      updateAvatarDisplay();
    });

    document.getElementById('nicknameInput').addEventListener('input', (e) => {
      document.getElementById('nicknameCount').textContent = e.target.value.length;
    });

    document.getElementById('createRoomBtn').addEventListener('click', async () => {
      const nickname = document.getElementById('nicknameInput').value.trim();
      if (!nickname) { showToast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 2500, true); return; }
      state.nickname = nickname;
      state.avatar = selectedAvatar;

      setButtonLoading('createRoomBtn', true, 'ì„œë²„ ì—°ê²° ì¤‘...');

      try {
        // ì„œë²„ ê¹¨ìš°ê¸° (Render ë¬´ë£Œ í”Œëœ ìŠ¬ë¦½ ëŒ€ì‘)
        if (!serverReady) {
          showToast('ğŸ”„ ì„œë²„ë¥¼ ê¹¨ìš°ëŠ” ì¤‘... (ìµœëŒ€ 30ì´ˆ ì†Œìš”)');
          await wakeUpServer();
        }
        const res = await fetch(`${SERVER_URL}/api/room`, {
          method: 'POST',
          signal: AbortSignal.timeout(20000)
        });
        if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
        const data = await res.json();
        serverReady = true;
        setButtonLoading('createRoomBtn', false, 'ìƒˆ ë°© ë§Œë“¤ê¸°');
        connectAndJoin(data.roomId, true);
      } catch (e) {
        setButtonLoading('createRoomBtn', false, 'ìƒˆ ë°© ë§Œë“¤ê¸°');
        showToast('âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨. SERVER_URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 4000, true);
        console.error('Create room error:', e);
      }
    });

    document.getElementById('joinRoomBtn').addEventListener('click', async () => {
      const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
      const nickname = document.getElementById('nicknameInput').value.trim();
      if (!nickname) { showToast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 2500, true); return; }
      if (!code || code.length < 4) { showToast('ë°© ì½”ë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”!', 2500, true); return; }
      state.nickname = nickname;
      state.avatar = selectedAvatar;

      setButtonLoading('joinRoomBtn', true, 'ì—°ê²° ì¤‘...');

      // ì„œë²„ ê¹¨ìš°ê¸°
      if (!serverReady) {
        showToast('ğŸ”„ ì„œë²„ë¥¼ ê¹¨ìš°ëŠ” ì¤‘... (ìµœëŒ€ 30ì´ˆ ì†Œìš”)');
        const ok = await wakeUpServer();
        if (!ok) {
          setButtonLoading('joinRoomBtn', false, 'ì°¸ê°€');
          showToast('âš ï¸ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 4000, true);
          return;
        }
      }

      // ë°© ì¡´ì¬ ì—¬ë¶€ ë¨¼ì € í™•ì¸ (ë” ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€)
      try {
        const check = await fetch(`${SERVER_URL}/api/room/${code}`, {
          signal: AbortSignal.timeout(10000)
        });
        if (!check.ok) {
          setButtonLoading('joinRoomBtn', false, 'ì°¸ê°€');
          const data = await check.json().catch(() => ({}));
          showToast(`âŒ ë°© ì½”ë“œ "${code}"ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì½”ë“œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.`, 4000, true);
          return;
        }
        const roomData = await check.json();
        if (roomData.state !== 'lobby') {
          setButtonLoading('joinRoomBtn', false, 'ì°¸ê°€');
          showToast('âš ï¸ í•´ë‹¹ ë°©ì—ì„œ ê²Œì„ì´ ì´ë¯¸ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', 3000, true);
          return;
        }
      } catch (e) {
        setButtonLoading('joinRoomBtn', false, 'ì°¸ê°€');
        showToast('âš ï¸ ì„œë²„ ì—°ê²° ì˜¤ë¥˜. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 4000, true);
        return;
      }

      setButtonLoading('joinRoomBtn', false, 'ì°¸ê°€');
      connectAndJoin(code, false);
    });

    // URL íŒŒë¼ë¯¸í„°ë¡œ ë°© ì½”ë“œ ìë™ ì…ë ¥
    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const roomId = params.get('room');
      if (roomId) {
        document.getElementById('roomCodeInput').value = roomId.toUpperCase();
        showToast('ğŸ“¨ ì´ˆëŒ€ ë§í¬ë¡œ ì ‘ì†í–ˆìŠµë‹ˆë‹¤. ë‹‰ë„¤ì„ì„ ì…ë ¥ í›„ ì°¸ê°€í•˜ì„¸ìš”!', 4000);
      }
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„œë²„ ì›¨ì´í¬ì—… ì‹œì‘
      wakeUpServer();
    });

    // ====== SOCKET CONNECTION ======
    function connectAndJoin(roomId, isCreating = false) {
      if (state.socket) {
        state.socket.disconnect();
        state.socket = null;
      }

      const rid = (roomId || '').toUpperCase().trim();
      const socket = io(SERVER_URL, {
        transports: ['websocket', 'polling'],
        reconnectionAttempts: 3,
        timeout: 10000,
      });
      state.socket = socket;
      state.roomId = rid;
      state.myId = null;

      socket.on('connect', () => {
        state.myId = socket.id;
        serverReady = true;
        socket.emit('join_room', {
          roomId: rid,
          nickname: state.nickname,
          avatar: state.avatar,
          createIfNotExists: isCreating, // ë°©ì¥ ì¬ì—°ê²° ì‹œ ë°© ì¬ìƒì„±
        });
      });

      socket.on('connect_error', (err) => {
        console.error('Socket connect error:', err);
        showToast('âŒ ì„œë²„ ì†Œì¼“ ì—°ê²° ì‹¤íŒ¨. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.', 5000, true);
      });

      socket.on('joined', ({ roomId: joinedRid, isHost }) => {
        state.isHost = isHost;
        setupLobby(joinedRid);
      });

      socket.on('room_update', ({ players, host, state: roomState, currentTurnPlayerId }) => {
        state.players = players;
        state.isHost = host === socket.id;
        updateLobbyPlayers(players, host);

        if (currentTurnPlayerId) {
          state.currentTurnPlayerId = currentTurnPlayerId;
          updateTurnUI();
        }

        // ê²Œì„ ì¢…ë£Œ í›„ ë¡œë¹„ë¡œ ëŒì•„ì˜¬ ë•Œ í™”ë©´ ì „í™˜ ë³´ì¥
        if (roomState === 'lobby') {
          const currentScreen = document.querySelector('.screen.active');
          if (currentScreen && currentScreen.id !== 'lobbyScreen') {
            hideOverlay('resultOverlay');
            hideOverlay('votingOverlay');
            clearVoteTimer();
            setupLobby(state.roomId);
          }
        }
      });

      socket.on('game_started', ({ isLiar, category, word, turnOrder, currentTurnPlayerId }) => {
        state.isLiar = isLiar;
        state.myWord = word;
        state.myCategory = category;
        state.turnOrder = turnOrder;
        state.currentTurnPlayerId = currentTurnPlayerId;
        state.round = 1;
        state.myVote = null;
        setupGameScreen();
        showScreen('gameScreen');
        hideOverlay('votingOverlay');
        hideOverlay('resultOverlay');
      });

      socket.on('chat_message', (msg) => {
        addChatMessage(msg);
      });

      socket.on('turn_changed', ({ currentTurnPlayerId, round }) => {
        state.currentTurnPlayerId = currentTurnPlayerId;
        state.round = round;
        document.getElementById('roundInfo').textContent = `${round}ë¼ìš´ë“œ`;
        updateTurnUI();
        updateChatInput();
        addSystemMessage(`${getPlayerName(currentTurnPlayerId)}ë‹˜ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤.`);
      });

      socket.on('voting_started', ({ timeLimit }) => {
        showVotingOverlay(timeLimit);
      });

      socket.on('vote_update', ({ voteCount, totalPlayers }) => {
        document.getElementById('voteCountInfo').textContent = `${voteCount}ëª… / ${totalPlayers}ëª… íˆ¬í‘œ ì™„ë£Œ`;
      });

      socket.on('vote_result', (result) => {
        clearVoteTimer();
        hideOverlay('votingOverlay');
        showResultOverlay(result);
      });

      socket.on('returned_to_lobby', () => {
        hideOverlay('resultOverlay');
        hideOverlay('votingOverlay');
        clearVoteTimer();
        setupLobby(state.roomId);
        updateLobbyPlayers(state.players, state.isHost ? socket.id : state.players.find(p => p.id === socket.id)?.id);
      });

      socket.on('became_host', () => {
        state.isHost = true;
        showToast('ğŸ‘‘ ë°©ì¥ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!');
        updateLobbyPlayers(state.players, socket.id);
      });

      socket.on('player_left', ({ playerId, nickname: leftName }) => {
        addSystemMessage(`${leftName || 'í”Œë ˆì´ì–´'}ë‹˜ì´ ë‚˜ê°”ìŠµë‹ˆë‹¤.`);
        if (state.turnOrder) {
          state.turnOrder = state.turnOrder.filter(p => p.id !== playerId);
        }
      });

      socket.on('error', ({ message }) => {
        showToast('âš ï¸ ' + message, 4000, true);
        // ì—°ê²°ì€ í–ˆì§€ë§Œ ë°© ì§„ì… ì‹¤íŒ¨ ì‹œ ì†Œì¼“ ì •ë¦¬
        socket.disconnect();
        state.socket = null;
      });
    }

    // ====== LOBBY ======
    function setupLobby(roomId) {
      const url = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
      document.getElementById('roomIdBadge').textContent = roomId;
      document.getElementById('inviteUrl').textContent = url;
      showScreen('lobbyScreen');
    }

    function updateLobbyPlayers(players, host) {
      const grid = document.getElementById('playersGrid');
      document.getElementById('playerCountDisplay').textContent = players.length;

      // Update start button
      const startBtn = document.getElementById('startGameBtn');
      const waitingText = document.getElementById('waitingText');
      if (state.isHost) {
        startBtn.style.display = 'block';
        waitingText.style.display = 'none';
        startBtn.disabled = players.length < 3;
        startBtn.textContent = players.length < 3 ? `ìµœì†Œ 3ëª… í•„ìš” (í˜„ì¬ ${players.length}ëª…)` : 'ê²Œì„ ì‹œì‘ ğŸ®';
      } else {
        startBtn.style.display = 'none';
        waitingText.style.display = 'block';
      }

      grid.innerHTML = '';
      players.forEach(p => {
        const card = document.createElement('div');
        card.className = 'player-card' + (p.id === host ? ' host' : '');
        const avatarEmoji = typeof p.avatar === 'object' ? p.avatar.emoji : p.avatar;
        card.innerHTML = `
      <span class="player-avatar-sm">${avatarEmoji}</span>
      <div class="player-name">${escapeHtml(p.nickname)}</div>
      ${p.id === host ? '<span class="host-crown">ğŸ‘‘ ë°©ì¥</span>' : ''}
    `;
        grid.appendChild(card);
      });

      // Empty slots
      for (let i = players.length; i < 8; i++) {
        const slot = document.createElement('div');
        slot.className = 'empty-slot';
        slot.textContent = 'ëŒ€ê¸° ì¤‘...';
        grid.appendChild(slot);
      }
    }

    document.getElementById('copyBtn').addEventListener('click', () => {
      const url = `${window.location.origin}${window.location.pathname}?room=${state.roomId}`;
      navigator.clipboard.writeText(url).then(() => {
        const btn = document.getElementById('copyBtn');
        btn.textContent = 'âœ“ ë³µì‚¬ë¨';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'ğŸ”— ì´ˆëŒ€ ë§í¬ ë³µì‚¬';
          btn.classList.remove('copied');
        }, 2000);
      });
    });

    document.getElementById('startGameBtn').addEventListener('click', () => {
      state.socket?.emit('start_game', { roomId: state.roomId });
    });

    // ====== GAME SCREEN ======
    function setupGameScreen() {
      // Role badge
      const badge = document.getElementById('myRoleBadge');
      if (state.isLiar) {
        badge.className = 'my-role-badge liar';
        badge.textContent = 'ë¼ì´ì–´ ğŸ­';
      } else {
        badge.className = 'my-role-badge citizen';
        badge.textContent = 'ì‹œë¯¼ ğŸ‘¤';
      }

      // Topic
      if (state.myWord) {
        document.getElementById('topicWord').textContent = state.myWord;
        document.getElementById('topicWord').style.display = 'block';
        document.getElementById('liarUnknown').style.display = 'none';
        document.getElementById('topicCategory').textContent = state.myCategory;
      } else {
        document.getElementById('topicWord').style.display = 'none';
        document.getElementById('liarUnknown').style.display = 'block';
        document.getElementById('topicCategory').textContent = state.myCategory + ' Â· ë¼ì´ì–´';
      }

      document.getElementById('roundInfo').textContent = '1ë¼ìš´ë“œ';

      // Clear chat
      document.getElementById('chatArea').innerHTML = '<div class="system-message">ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ë¼ì´ì–´ë¥¼ ì°¾ì•„ë¼! ğŸ•µï¸</div>';

      // Turn list
      updateTurnList();
      updateTurnUI();
      updateChatInput();

      // Host actions
      if (state.isHost) {
        document.getElementById('hostActionsCard').style.display = 'block';
        document.getElementById('nonHostActionsCard').style.display = 'none';
      } else {
        document.getElementById('hostActionsCard').style.display = 'none';
        document.getElementById('nonHostActionsCard').style.display = 'block';
      }
    }

    function updateTurnList() {
      const list = document.getElementById('turnList');
      list.innerHTML = '';
      state.turnOrder.forEach((player, i) => {
        const isCurrent = player.id === state.currentTurnPlayerId;
        const avatarEmoji = typeof player.avatar === 'object' ? player.avatar.emoji : player.avatar;
        const div = document.createElement('div');
        div.className = 'turn-player' + (isCurrent ? ' current' : '');
        div.dataset.playerId = player.id;
        div.innerHTML = `
      <div class="turn-num">${i + 1}</div>
      <div class="turn-avatar">${avatarEmoji}</div>
      <div class="turn-name">${escapeHtml(player.nickname)}</div>
      ${isCurrent ? '<div class="turn-indicator">ë°œì–¸ ì¤‘</div>' : ''}
    `;
        list.appendChild(div);
      });
    }

    function updateTurnUI() {
      document.querySelectorAll('.turn-player').forEach(el => {
        const isCurrent = el.dataset.playerId === state.currentTurnPlayerId;
        el.className = 'turn-player' + (isCurrent ? ' current' : '');
        el.querySelector('.turn-indicator') && el.querySelector('.turn-indicator').remove();
        if (isCurrent) {
          const ind = document.createElement('div');
          ind.className = 'turn-indicator';
          ind.textContent = 'ë°œì–¸ ì¤‘';
          el.appendChild(ind);
        }
      });
    }

    function updateChatInput() {
      const isMyTurn = state.currentTurnPlayerId === (state.myId || state.socket?.id);
      const input = document.getElementById('chatInput');
      const btn = document.getElementById('sendBtn');
      input.disabled = !isMyTurn;
      btn.disabled = !isMyTurn;
      input.placeholder = isMyTurn ? 'ë‹¨ì–´ë¥¼ ì„¤ëª…í•˜ì„¸ìš”...' : 'ë‹¤ë¥¸ í”Œë ˆì´ì–´ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤...';
      if (isMyTurn) {
        input.focus();
        addSystemMessage('â¬†ï¸ ë‚´ ì°¨ë¡€ì…ë‹ˆë‹¤! ë‹¨ì–´ë¥¼ ì„¤ëª…í•˜ì„¸ìš”.');
      }
    }

    function addChatMessage(msg) {
      const area = document.getElementById('chatArea');
      const isMe = msg.playerId === (state.myId || state.socket?.id);
      const avatarEmoji = typeof msg.avatar === 'object' ? msg.avatar.emoji : (msg.avatar || 'ğŸ‘¤');

      const div = document.createElement('div');
      div.className = 'chat-message' + (isMe ? ' mine' : '');
      div.innerHTML = `
    <div class="chat-avatar">${avatarEmoji}</div>
    <div class="chat-bubble-wrap">
      <div class="chat-sender">${escapeHtml(msg.nickname)}</div>
      <div class="chat-bubble">${escapeHtml(msg.message)}</div>
    </div>
  `;
      area.appendChild(div);
      area.scrollTop = area.scrollHeight;
    }

    function addSystemMessage(text) {
      const area = document.getElementById('chatArea');
      const div = document.createElement('div');
      div.className = 'system-message';
      div.textContent = text;
      area.appendChild(div);
      area.scrollTop = area.scrollHeight;
    }

    function getPlayerName(id) {
      const player = state.turnOrder.find(p => p.id === id);
      return player?.nickname || '???';
    }

    // Send chat
    document.getElementById('sendBtn').addEventListener('click', sendChat);
    document.getElementById('chatInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendChat();
    });

    function sendChat() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;
      state.socket?.emit('send_chat', { roomId: state.roomId, message });
      input.value = '';
    }

    // Vote button
    document.getElementById('callVoteBtn').addEventListener('click', () => {
      state.socket?.emit('call_vote', { roomId: state.roomId });
    });

    document.getElementById('nextRoundBtn').addEventListener('click', () => {
      state.socket?.emit('next_turn', { roomId: state.roomId });
    });

    // ====== VOTING ======
    function showVotingOverlay(timeLimit) {
      state.myVote = null;
      state.voteTimeLeft = timeLimit;

      // Build vote player list
      const container = document.getElementById('votePlayers');
      container.innerHTML = '';
      state.players.forEach(p => {
        if (p.id === (state.myId || state.socket?.id)) return; // can't vote for self
        const avatarEmoji = typeof p.avatar === 'object' ? p.avatar.emoji : (p.avatar || 'ğŸ‘¤');
        const btn = document.createElement('button');
        btn.className = 'vote-player-btn';
        btn.dataset.playerId = p.id;
        btn.innerHTML = `
      <div class="vote-player-avatar">${avatarEmoji}</div>
      <div class="vote-player-name">${escapeHtml(p.nickname)}</div>
    `;
        btn.addEventListener('click', () => submitVote(p.id));
        container.appendChild(btn);
      });

      document.getElementById('voteCountInfo').textContent = '0ëª… íˆ¬í‘œ ì™„ë£Œ';
      document.getElementById('voteTimer').textContent = timeLimit;
      document.getElementById('voteProgressBar').style.width = '100%';

      showOverlay('votingOverlay');
      startVoteTimer(timeLimit);
    }

    function startVoteTimer(total) {
      clearVoteTimer();
      const timerEl = document.getElementById('voteTimer');
      const barEl = document.getElementById('voteProgressBar');

      state.voteTimerInterval = setInterval(() => {
        state.voteTimeLeft--;
        timerEl.textContent = state.voteTimeLeft;
        barEl.style.width = (state.voteTimeLeft / total * 100) + '%';

        if (state.voteTimeLeft <= 10) {
          timerEl.classList.add('urgent');
        }

        if (state.voteTimeLeft <= 0) {
          clearVoteTimer();
        }
      }, 1000);
    }

    function clearVoteTimer() {
      clearInterval(state.voteTimerInterval);
      document.getElementById('voteTimer').classList.remove('urgent');
    }

    function submitVote(targetId) {
      if (state.myVote) return;
      state.myVote = targetId;

      document.querySelectorAll('.vote-player-btn').forEach(btn => {
        btn.classList.add('voted');
        if (btn.dataset.playerId === targetId) btn.classList.add('selected');
      });

      state.socket?.emit('submit_vote', { roomId: state.roomId, targetId });
      showToast('íˆ¬í‘œ ì™„ë£Œ!');
    }

    // ====== RESULT ======
    function showResultOverlay(result) {
      const { eliminated, isLiar, liar, topic } = result;

      const outcomeEl = document.getElementById('resultOutcome');
      const descEl = document.getElementById('resultDesc');

      if (isLiar) {
        outcomeEl.textContent = 'ğŸ‰ ì‹œë¯¼ ìŠ¹ë¦¬!';
        outcomeEl.className = 'result-outcome citizens-win';
        descEl.textContent = `ë¼ì´ì–´ë¥¼ ì¡ì•˜ìŠµë‹ˆë‹¤!`;
      } else {
        outcomeEl.textContent = 'ğŸ­ ë¼ì´ì–´ ìŠ¹ë¦¬!';
        outcomeEl.className = 'result-outcome liar-win';
        descEl.textContent = eliminated
          ? `${eliminated.nickname}ë‹˜ì€ ë¼ì´ì–´ê°€ ì•„ë‹ˆì—ˆìŠµë‹ˆë‹¤...`
          : 'íˆ¬í‘œì—ì„œ ì•„ë¬´ë„ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
      }

      if (liar) {
        const liarAvatarEmoji = typeof liar.avatar === 'object' ? liar.avatar.emoji : (liar.avatar || 'ğŸ‘¤');
        document.getElementById('resultLiarAvatar').textContent = liarAvatarEmoji;
        document.getElementById('resultLiarName').textContent = liar.nickname;
      }

      document.getElementById('resultTopicWord').textContent = topic?.word || '-';
      document.getElementById('resultTopicCat').textContent = topic?.category || '-';

      showOverlay('resultOverlay');
    }

    document.getElementById('returnToLobbyBtn').addEventListener('click', () => {
      if (state.isHost) {
        // ì„œë²„ì— ì´ë²¤íŠ¸ ë³´ë‚´ê³  returned_to_lobby ì‘ë‹µ ê¸°ë‹¤ë¦¼ (ë°©ì¥ë„ ë™ì¼í•˜ê²Œ ì²˜ë¦¬)
        state.socket?.emit('return_to_lobby', { roomId: state.roomId });
      } else {
        // ë¹„ë°©ì¥ì€ ì„œë²„ ì´ë²¤íŠ¸(returned_to_lobby / room_update)ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ëŒ€ê¸°
        // ë§Œì•½ ì†Œì¼“ì´ ëŠê¸´ ê²½ìš° fallback
        if (!state.socket?.connected) {
          hideOverlay('resultOverlay');
          showScreen('lobbyScreen');
        }
      }
    });

    // ====== DEMO MODE ======
    function runDemoMode() {
      const roomId = state.roomId || 'DEMO0001';
      state.roomId = roomId;
      state.myId = 'me';
      state.isHost = true;

      const demoPlayers = [
        { id: 'me', nickname: state.nickname, avatar: state.avatar },
        { id: 'p2', nickname: 'ì² ìˆ˜', avatar: AVATARS[1] },
        { id: 'p3', nickname: 'ì˜í¬', avatar: AVATARS[2] },
        { id: 'p4', nickname: 'ë¯¼ì¤€', avatar: AVATARS[3] },
      ];
      state.players = demoPlayers;

      setupLobby(roomId);
      updateLobbyPlayers(demoPlayers, 'me');

      document.getElementById('startGameBtn').addEventListener('click', () => {
        const topic = { category: 'ìŒì‹', word: 'í”¼ì' };
        const liarIndex = 1; // p2 is liar
        const turnOrder = [
          { id: 'me', nickname: state.nickname, avatar: state.avatar },
          { id: 'p2', nickname: 'ì² ìˆ˜', avatar: AVATARS[1] },
          { id: 'p3', nickname: 'ì˜í¬', avatar: AVATARS[2] },
          { id: 'p4', nickname: 'ë¯¼ì¤€', avatar: AVATARS[3] },
        ];

        state.isLiar = false;
        state.myWord = 'í”¼ì';
        state.myCategory = 'ìŒì‹';
        state.turnOrder = turnOrder;
        state.currentTurnPlayerId = 'me';
        state.round = 1;
        state.myVote = null;

        setupGameScreen();
        showScreen('gameScreen');

        // Demo: simulate other players
        setTimeout(() => {
          if (state.currentTurnPlayerId !== 'me') return;
        }, 1000);
      }, { once: true });

      // Simulate chat sends in demo
      const origSendChat = sendChat;
      document.getElementById('sendBtn').addEventListener('click', () => {
        // handled by real sendChat which calls socket
      });
    }

    // ====== UTILS ======
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // ====== INIT ======
    // Check URL for room invite
    window.addEventListener('load', () => {
      const params = new URLSearchParams(window.location.search);
      const roomParam = params.get('room');
      if (roomParam) {
        document.getElementById('roomCodeInput').value = roomParam;
        showToast('ë°© ì½”ë“œê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      }
    });
  </script>
</body>

</html>