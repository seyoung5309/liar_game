<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¼ì´ì–´ ê²Œì„</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;900&family=Black+Han+Sans&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<style>
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface2: #1a1a28;
  --border: #2a2a40;
  --accent: #e63946;
  --accent2: #ff6b6b;
  --gold: #ffd166;
  --teal: #06d6a0;
  --purple: #7b2fff;
  --text: #f0eeff;
  --text-muted: #888899;
  --shadow: 0 0 40px rgba(230,57,70,0.15);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Noto Sans KR', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: 
    radial-gradient(ellipse 60% 40% at 20% 10%, rgba(123,47,255,0.12) 0%, transparent 60%),
    radial-gradient(ellipse 50% 50% at 80% 90%, rgba(230,57,70,0.1) 0%, transparent 60%);
  pointer-events: none;
  z-index: 0;
}

/* ====== SCREENS ====== */
.screen {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 10;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
}
.screen.active {
  opacity: 1;
  pointer-events: all;
}

/* ====== TITLE SCREEN ====== */
.title-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2.5rem;
  width: 100%;
  max-width: 480px;
  padding: 2rem;
}

.game-logo {
  text-align: center;
}

.logo-eyebrow {
  font-size: 0.75rem;
  letter-spacing: 0.4em;
  color: var(--accent);
  text-transform: uppercase;
  margin-bottom: 0.5rem;
}

.logo-title {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 4.5rem;
  line-height: 1;
  background: linear-gradient(135deg, #fff 0%, var(--accent2) 50%, var(--accent) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: none;
  filter: drop-shadow(0 0 30px rgba(230,57,70,0.4));
}

.logo-sub {
  font-size: 1.1rem;
  color: var(--text-muted);
  margin-top: 0.5rem;
  letter-spacing: 0.1em;
}

/* Avatar section */
.avatar-section {
  width: 100%;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 1.5rem;
}

.section-label {
  font-size: 0.7rem;
  letter-spacing: 0.3em;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 1rem;
}

.avatar-preview {
  display: flex;
  align-items: center;
  gap: 1.2rem;
  margin-bottom: 1rem;
}

.avatar-display {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: var(--surface2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
  border: 2px solid var(--border);
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.avatar-display.animate {
  animation: avatarPop 0.3s ease;
}

@keyframes avatarPop {
  0% { transform: scale(0.8); opacity: 0.5; }
  60% { transform: scale(1.1); }
  100% { transform: scale(1); opacity: 1; }
}

.avatar-info {
  flex: 1;
}

.avatar-name {
  font-size: 1rem;
  font-weight: 700;
  margin-bottom: 0.2rem;
}

.avatar-desc {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.btn-random {
  width: 100%;
  padding: 0.7rem;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text);
  font-family: inherit;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.btn-random:hover {
  border-color: var(--purple);
  background: rgba(123,47,255,0.1);
}

.dice-icon {
  font-size: 1.1rem;
  transition: transform 0.3s;
}

.btn-random:hover .dice-icon { transform: rotate(20deg); }

/* Input */
.input-wrap {
  width: 100%;
}

.game-input {
  width: 100%;
  padding: 1rem 1.2rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  color: var(--text);
  font-family: inherit;
  font-size: 1rem;
  outline: none;
  transition: all 0.2s;
}

.game-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(230,57,70,0.15);
}

.input-hint {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 0.4rem;
  text-align: right;
}

/* Buttons */
.btn-primary {
  width: 100%;
  padding: 1rem;
  background: var(--accent);
  border: none;
  border-radius: 14px;
  color: white;
  font-family: 'Black Han Sans', sans-serif;
  font-size: 1.2rem;
  letter-spacing: 0.1em;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.btn-primary::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
}

.btn-primary:hover {
  background: var(--accent2);
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(230,57,70,0.4);
}

.btn-primary:active { transform: translateY(0); }

.btn-secondary {
  padding: 0.7rem 1.2rem;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: inherit;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-secondary:hover {
  border-color: var(--teal);
  color: var(--teal);
}

/* ====== LOBBY SCREEN ====== */
.lobby-wrap {
  width: 100%;
  max-width: 560px;
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1.2rem;
}

.lobby-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.lobby-title {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 1.8rem;
  background: linear-gradient(135deg, #fff, var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.room-id-badge {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 0.3rem 0.8rem;
  font-size: 0.8rem;
  color: var(--text-muted);
  font-family: monospace;
}

.invite-bar {
  display: flex;
  gap: 0.8rem;
  align-items: center;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 0.8rem 1rem;
}

.invite-url {
  flex: 1;
  font-size: 0.8rem;
  color: var(--text-muted);
  font-family: monospace;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.btn-copy {
  padding: 0.4rem 0.9rem;
  background: var(--purple);
  border: none;
  border-radius: 8px;
  color: white;
  font-family: inherit;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.btn-copy:hover { background: #9b4fff; }
.btn-copy.copied { background: var(--teal); }

.players-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 0.8rem;
}

.player-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 1rem 0.8rem;
  text-align: center;
  transition: all 0.3s ease;
  animation: playerEnter 0.3s ease;
}

@keyframes playerEnter {
  from { opacity: 0; transform: translateY(10px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.player-card.host {
  border-color: var(--gold);
  box-shadow: 0 0 20px rgba(255,209,102,0.1);
}

.player-avatar-sm {
  font-size: 2.2rem;
  margin-bottom: 0.4rem;
  display: block;
}

.player-name {
  font-size: 0.8rem;
  font-weight: 700;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.host-crown {
  font-size: 0.65rem;
  color: var(--gold);
  display: block;
  margin-top: 0.2rem;
}

.empty-slot {
  background: var(--surface);
  border: 1px dashed var(--border);
  border-radius: 14px;
  padding: 1rem 0.8rem;
  text-align: center;
  color: var(--text-muted);
  font-size: 0.75rem;
}

.lobby-actions {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

.waiting-text {
  text-align: center;
  color: var(--text-muted);
  font-size: 0.85rem;
}

/* ====== GAME SCREEN ====== */
#gameScreen {
  justify-content: flex-start;
  overflow-y: auto;
}

.game-layout {
  width: 100%;
  max-width: 900px;
  height: 100vh;
  display: grid;
  grid-template-rows: auto 1fr auto;
  grid-template-columns: 1fr 300px;
  grid-template-areas: 
    "header header"
    "chat sidebar"
    "input sidebar";
  gap: 0;
  padding: 1rem;
  gap: 0.8rem;
}

.game-header {
  grid-area: header;
  display: flex;
  align-items: center;
  gap: 1rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 0.8rem 1.2rem;
}

.my-role-badge {
  padding: 0.4rem 0.9rem;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 700;
  letter-spacing: 0.05em;
}

.my-role-badge.citizen {
  background: rgba(6,214,160,0.15);
  border: 1px solid var(--teal);
  color: var(--teal);
}

.my-role-badge.liar {
  background: rgba(230,57,70,0.15);
  border: 1px solid var(--accent);
  color: var(--accent);
  animation: liarPulse 2s infinite;
}

@keyframes liarPulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(230,57,70,0.4); }
  50% { box-shadow: 0 0 0 6px rgba(230,57,70,0); }
}

.topic-display {
  flex: 1;
  text-align: center;
}

.topic-category {
  font-size: 0.7rem;
  color: var(--text-muted);
  letter-spacing: 0.2em;
  text-transform: uppercase;
}

.topic-word {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 1.4rem;
  color: var(--gold);
}

.liar-unknown {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 1.1rem;
  color: var(--text-muted);
  letter-spacing: 0.1em;
}

.round-info {
  font-size: 0.8rem;
  color: var(--text-muted);
  text-align: right;
}

/* Chat area */
.chat-area {
  grid-area: chat;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 1rem;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

.chat-message {
  display: flex;
  gap: 0.8rem;
  align-items: flex-start;
  animation: msgIn 0.3s ease;
}

@keyframes msgIn {
  from { opacity: 0; transform: translateX(-10px); }
  to { opacity: 1; transform: translateX(0); }
}

.chat-message.mine {
  flex-direction: row-reverse;
}

.chat-avatar {
  font-size: 1.8rem;
  flex-shrink: 0;
  width: 40px;
  text-align: center;
}

.chat-bubble-wrap {
  max-width: 70%;
}

.chat-sender {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-bottom: 0.2rem;
}

.chat-message.mine .chat-sender {
  text-align: right;
}

.chat-bubble {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 0.6rem 0.9rem;
  font-size: 0.95rem;
  line-height: 1.5;
  word-break: break-word;
}

.chat-message.mine .chat-bubble {
  background: rgba(230,57,70,0.15);
  border-color: rgba(230,57,70,0.3);
}

.system-message {
  text-align: center;
  font-size: 0.75rem;
  color: var(--text-muted);
  padding: 0.3rem;
  letter-spacing: 0.05em;
}

/* Input area */
.chat-input-area {
  grid-area: input;
  display: flex;
  gap: 0.6rem;
}

.chat-input {
  flex: 1;
  padding: 0.8rem 1rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text);
  font-family: inherit;
  font-size: 0.95rem;
  outline: none;
  transition: all 0.2s;
}

.chat-input:focus {
  border-color: var(--accent);
}

.chat-input:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.btn-send {
  padding: 0.8rem 1.2rem;
  background: var(--accent);
  border: none;
  border-radius: 12px;
  color: white;
  font-size: 1.1rem;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-send:hover { background: var(--accent2); }
.btn-send:disabled { opacity: 0.4; cursor: not-allowed; }

/* Sidebar */
.game-sidebar {
  grid-area: sidebar;
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

.sidebar-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 1rem;
}

.sidebar-title {
  font-size: 0.7rem;
  letter-spacing: 0.25em;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 0.8rem;
}

.turn-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.turn-player {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  padding: 0.5rem 0.7rem;
  border-radius: 10px;
  transition: all 0.3s;
  border: 1px solid transparent;
}

.turn-player.current {
  background: rgba(230,57,70,0.1);
  border-color: rgba(230,57,70,0.3);
}

.turn-player.done {
  opacity: 0.5;
}

.turn-num {
  font-size: 0.7rem;
  color: var(--text-muted);
  width: 16px;
  text-align: center;
  flex-shrink: 0;
}

.turn-avatar {
  font-size: 1.4rem;
}

.turn-name {
  font-size: 0.85rem;
  font-weight: 600;
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.turn-indicator {
  font-size: 0.65rem;
  color: var(--accent);
  font-weight: 700;
}

.vote-actions {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.btn-vote {
  width: 100%;
  padding: 0.7rem;
  background: rgba(230,57,70,0.15);
  border: 1px solid rgba(230,57,70,0.3);
  border-radius: 10px;
  color: var(--accent2);
  font-family: inherit;
  font-size: 0.85rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-vote:hover {
  background: rgba(230,57,70,0.25);
  box-shadow: 0 0 15px rgba(230,57,70,0.2);
}

.btn-skip {
  width: 100%;
  padding: 0.7rem;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-muted);
  font-family: inherit;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-skip:hover { border-color: var(--teal); color: var(--teal); }

/* ====== VOTING OVERLAY ====== */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(10,10,15,0.85);
  backdrop-filter: blur(8px);
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}

.overlay.active {
  opacity: 1;
  pointer-events: all;
}

.vote-modal {
  width: 100%;
  max-width: 480px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 2rem;
  margin: 1rem;
}

.vote-header {
  text-align: center;
  margin-bottom: 1.5rem;
}

.vote-title {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 1.8rem;
  color: var(--accent2);
  margin-bottom: 0.3rem;
}

.vote-subtitle {
  font-size: 0.85rem;
  color: var(--text-muted);
}

.vote-timer {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 3rem;
  color: var(--gold);
  text-align: center;
  margin-bottom: 1rem;
  transition: color 0.3s;
}

.vote-timer.urgent { color: var(--accent); animation: timerBlink 0.5s infinite; }

@keyframes timerBlink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.vote-progress {
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  margin-bottom: 1.5rem;
  overflow: hidden;
}

.vote-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 2px;
  transition: width 1s linear;
}

.vote-players {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.7rem;
  margin-bottom: 1.5rem;
}

.vote-player-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.4rem;
  padding: 0.9rem 0.5rem;
  background: var(--surface2);
  border: 2px solid var(--border);
  border-radius: 14px;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--text);
  font-family: inherit;
}

.vote-player-btn:hover {
  border-color: var(--accent);
  background: rgba(230,57,70,0.1);
  transform: scale(1.03);
}

.vote-player-btn.selected {
  border-color: var(--accent);
  background: rgba(230,57,70,0.2);
}

.vote-player-btn.voted {
  border-color: var(--gold);
  background: rgba(255,209,102,0.1);
  cursor: default;
}

.vote-player-avatar { font-size: 2rem; }
.vote-player-name { font-size: 0.8rem; font-weight: 700; }

.vote-count-info {
  text-align: center;
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-bottom: 1rem;
}

/* ====== RESULT OVERLAY ====== */
.result-modal {
  width: 100%;
  max-width: 480px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 2.5rem 2rem;
  margin: 1rem;
  text-align: center;
}

.result-outcome {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
  animation: resultReveal 0.5s ease;
}

@keyframes resultReveal {
  from { opacity: 0; transform: scale(0.8) translateY(20px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}

.result-outcome.citizens-win { color: var(--teal); }
.result-outcome.liar-win { color: var(--accent); }

.result-desc {
  color: var(--text-muted);
  font-size: 0.9rem;
  margin-bottom: 1.5rem;
}

.result-liar-reveal {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 1.2rem;
  margin-bottom: 1.5rem;
}

.result-liar-label {
  font-size: 0.7rem;
  letter-spacing: 0.25em;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 0.5rem;
}

.result-liar-player {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.8rem;
  margin-bottom: 0.5rem;
}

.result-liar-avatar { font-size: 2.5rem; }

.result-liar-name {
  font-size: 1.2rem;
  font-weight: 700;
}

.result-topic {
  font-size: 0.85rem;
  color: var(--text-muted);
}

.result-topic-word {
  color: var(--gold);
  font-weight: 700;
}

/* ====== MOBILE ====== */
@media (max-width: 700px) {
  .game-layout {
    grid-template-columns: 1fr;
    grid-template-rows: auto 1fr 200px auto;
    grid-template-areas:
      "header"
      "chat"
      "sidebar"
      "input";
    height: auto;
    min-height: 100vh;
    padding: 0.7rem;
  }

  .logo-title { font-size: 3rem; }
  .vote-players { grid-template-columns: repeat(2, 1fr); }
}

/* Toast */
.toast {
  position: fixed;
  bottom: 2rem;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 0.7rem 1.2rem;
  font-size: 0.85rem;
  opacity: 0;
  transition: all 0.3s;
  z-index: 200;
  white-space: nowrap;
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* Particle / decorative */
.floating-particles {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 1;
  overflow: hidden;
}

.particle {
  position: absolute;
  border-radius: 50%;
  animation: float linear infinite;
  opacity: 0.15;
}

@keyframes float {
  0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
  10% { opacity: 0.15; }
  90% { opacity: 0.15; }
  100% { transform: translateY(-100px) rotate(720deg); opacity: 0; }
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255,255,255,0.2);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  display: inline-block;
}

@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<!-- Particles -->
<div class="floating-particles" id="particles"></div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- ====== TITLE SCREEN ====== -->
<div class="screen active" id="titleScreen">
  <div class="title-wrap">
    <div class="game-logo">
      <div class="logo-eyebrow">ğŸ­ SOCIAL DEDUCTION</div>
      <div class="logo-title">ë¼ì´ì–´ê²Œì„</div>
      <div class="logo-sub">ê±°ì§“ë§ìŸì´ë¥¼ ì°¾ì•„ë¼</div>
    </div>

    <div class="avatar-section">
      <div class="section-label">ìºë¦­í„° ì„ íƒ</div>
      <div class="avatar-preview">
        <div class="avatar-display" id="avatarDisplay">ğŸ­</div>
        <div class="avatar-info">
          <div class="avatar-name" id="avatarName">ëœë¤ ì„ íƒ</div>
          <div class="avatar-desc" id="avatarDesc">ë²„íŠ¼ì„ ëˆŒëŸ¬ ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
        </div>
      </div>
      <button class="btn-random" id="randomBtn">
        <span class="dice-icon">ğŸ²</span>
        ëœë¤ ìºë¦­í„° ì„ íƒ
      </button>
    </div>

    <div class="input-wrap">
      <input class="game-input" type="text" id="nicknameInput" 
             placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="16" autocomplete="off">
      <div class="input-hint"><span id="nicknameCount">0</span>/16</div>
    </div>

    <div style="width:100%; display:flex; flex-direction:column; gap:0.6rem;">
      <button class="btn-primary" id="createRoomBtn">ìƒˆ ë°© ë§Œë“¤ê¸°</button>
      <div style="text-align:center; color:var(--text-muted); font-size:0.8rem; position:relative;">
        <span style="background:var(--bg); padding:0 0.8rem; position:relative; z-index:1;">ë˜ëŠ”</span>
        <div style="position:absolute; top:50%; left:0; right:0; height:1px; background:var(--border);"></div>
      </div>
      <div style="display:flex; gap:0.6rem;">
        <input class="game-input" type="text" id="roomCodeInput" 
               placeholder="ë°© ì½”ë“œ ì…ë ¥" maxlength="8" style="text-transform:uppercase; letter-spacing:0.15em; flex:1;">
        <button class="btn-secondary" id="joinRoomBtn" style="white-space:nowrap;">ì°¸ê°€</button>
      </div>
    </div>
  </div>
</div>

<!-- ====== LOBBY SCREEN ====== -->
<div class="screen" id="lobbyScreen">
  <div class="lobby-wrap">
    <div class="lobby-header">
      <div class="lobby-title">ğŸ  ëŒ€ê¸°ì‹¤</div>
      <div class="room-id-badge" id="roomIdBadge">ROOM-####</div>
    </div>

    <div class="invite-bar">
      <div class="invite-url" id="inviteUrl">https://...</div>
      <button class="btn-copy" id="copyBtn">ğŸ”— ì´ˆëŒ€ ë§í¬ ë³µì‚¬</button>
    </div>

    <div>
      <div class="section-label" style="margin-bottom:0.8rem;">ì°¸ê°€ì <span id="playerCountDisplay">0</span>/8</div>
      <div class="players-grid" id="playersGrid"></div>
    </div>

    <div class="lobby-actions">
      <button class="btn-primary" id="startGameBtn" style="display:none;">ê²Œì„ ì‹œì‘ ğŸ®</button>
      <div class="waiting-text" id="waitingText">ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•˜ê¸¸ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
    </div>
  </div>
</div>

<!-- ====== GAME SCREEN ====== -->
<div class="screen" id="gameScreen">
  <div class="game-layout">
    <!-- Header -->
    <div class="game-header">
      <div class="my-role-badge citizen" id="myRoleBadge">ì‹œë¯¼ ğŸ‘¤</div>
      <div class="topic-display">
        <div class="topic-category" id="topicCategory">ì¹´í…Œê³ ë¦¬</div>
        <div class="topic-word" id="topicWord" style="display:none;"></div>
        <div class="liar-unknown" id="liarUnknown" style="display:none;">???</div>
      </div>
      <div class="round-info" id="roundInfo">1ë¼ìš´ë“œ</div>
    </div>

    <!-- Chat -->
    <div class="chat-area" id="chatArea">
      <div class="system-message">ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ë¼ì´ì–´ë¥¼ ì°¾ì•„ë¼! ğŸ•µï¸</div>
    </div>

    <!-- Chat Input -->
    <div class="chat-input-area">
      <input class="chat-input" id="chatInput" placeholder="ë‚´ ì°¨ë¡€ì— ë‹¨ì–´ë¥¼ ì„¤ëª…í•˜ì„¸ìš”..." disabled>
      <button class="btn-send" id="sendBtn" disabled>â¤</button>
    </div>

    <!-- Sidebar -->
    <div class="game-sidebar">
      <div class="sidebar-card">
        <div class="sidebar-title">ë°œì–¸ ìˆœì„œ</div>
        <div class="turn-list" id="turnList"></div>
      </div>
      <div class="sidebar-card" id="hostActionsCard" style="display:none;">
        <div class="sidebar-title">ì§„í–‰</div>
        <div class="vote-actions">
          <button class="btn-vote" id="callVoteBtn">ğŸ—³ï¸ íˆ¬í‘œ ì‹œì‘</button>
          <button class="btn-skip" id="nextRoundBtn">ë‹¤ìŒ ë¼ìš´ë“œ âœ</button>
        </div>
      </div>
      <div class="sidebar-card" id="nonHostActionsCard" style="display:none;">
        <div class="sidebar-title">ì§„í–‰</div>
        <div style="font-size:0.8rem; color:var(--text-muted); text-align:center;">ë°©ì¥ì´ ë¼ìš´ë“œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤</div>
      </div>
    </div>
  </div>
</div>

<!-- ====== VOTING OVERLAY ====== -->
<div class="overlay" id="votingOverlay">
  <div class="vote-modal">
    <div class="vote-header">
      <div class="vote-title">ğŸ—³ï¸ íˆ¬í‘œ</div>
      <div class="vote-subtitle">ë¼ì´ì–´ë¼ê³  ìƒê°í•˜ëŠ” í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
    </div>
    <div class="vote-timer" id="voteTimer">60</div>
    <div class="vote-progress">
      <div class="vote-progress-bar" id="voteProgressBar" style="width:100%;"></div>
    </div>
    <div class="vote-count-info" id="voteCountInfo">0ëª… íˆ¬í‘œ ì™„ë£Œ</div>
    <div class="vote-players" id="votePlayers"></div>
    <div style="text-align:center; color:var(--text-muted); font-size:0.8rem;">íˆ¬í‘œ í›„ ë³€ê²½ ë¶ˆê°€</div>
  </div>
</div>

<!-- ====== RESULT OVERLAY ====== -->
<div class="overlay" id="resultOverlay">
  <div class="result-modal">
    <div class="result-outcome" id="resultOutcome">ì‹œë¯¼ ìŠ¹ë¦¬!</div>
    <div class="result-desc" id="resultDesc">ë¼ì´ì–´ë¥¼ ì°¾ì•„ëƒˆìŠµë‹ˆë‹¤.</div>
    <div class="result-liar-reveal">
      <div class="result-liar-label">ë¼ì´ì–´</div>
      <div class="result-liar-player">
        <div class="result-liar-avatar" id="resultLiarAvatar">ğŸ­</div>
        <div class="result-liar-name" id="resultLiarName">í”Œë ˆì´ì–´</div>
      </div>
      <div class="result-topic">
        ì •ë‹µ: <span class="result-topic-word" id="resultTopicWord">ë‹¨ì–´</span>
        <span style="color:var(--text-muted);"> (ì¹´í…Œê³ ë¦¬: </span><span id="resultTopicCat">-</span><span style="color:var(--text-muted);">)</span>
      </div>
    </div>
    <button class="btn-primary" id="returnToLobbyBtn">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
  </div>
</div>

<script>
// ====== CONFIG ======
const SERVER_URL = 'https://your-server.onrender.com'; // Replace with your Render URL

// ====== AVATARS ======
const AVATARS = [
  { emoji: 'ğŸ¦Š', name: 'ì—¬ìš°', desc: 'êµí™œí•œ ì—¬ìš°' },
  { emoji: 'ğŸº', name: 'ëŠ‘ëŒ€', desc: 'ì‹ ë¹„ë¡œìš´ ëŠ‘ëŒ€' },
  { emoji: 'ğŸ¦', name: 'ì‚¬ì', desc: 'ìš©ê°í•œ ì‚¬ì' },
  { emoji: 'ğŸ¯', name: 'í˜¸ë‘ì´', desc: 'ê°•ì¸í•œ í˜¸ë‘ì´' },
  { emoji: 'ğŸ»', name: 'ê³°', desc: 'ë“¬ì§í•œ ê³°' },
  { emoji: 'ğŸ¦', name: 'ë„ˆêµ¬ë¦¬', desc: 'ì¥ë‚œìŠ¤ëŸ° ë„ˆêµ¬ë¦¬' },
  { emoji: 'ğŸ¸', name: 'ê°œêµ¬ë¦¬', desc: 'ì¾Œí™œí•œ ê°œêµ¬ë¦¬' },
  { emoji: 'ğŸ¦‰', name: 'ë¶€ì—‰ì´', desc: 'ì§€í˜œë¡œìš´ ë¶€ì—‰ì´' },
  { emoji: 'ğŸ™', name: 'ë¬¸ì–´', desc: 'ì‹ ë¹„í•œ ë¬¸ì–´' },
  { emoji: 'ğŸ¦‹', name: 'ë‚˜ë¹„', desc: 'ìš°ì•„í•œ ë‚˜ë¹„' },
  { emoji: 'ğŸ²', name: 'ë“œë˜ê³¤', desc: 'ì „ì„¤ì˜ ë“œë˜ê³¤' },
  { emoji: 'ğŸ¦„', name: 'ìœ ë‹ˆì½˜', desc: 'ë§ˆë²•ì˜ ìœ ë‹ˆì½˜' },
  { emoji: 'ğŸº', name: 'ëŠ‘ëŒ€ì¸ê°„', desc: 'ë‹¬ë¹›ì˜ ëŠ‘ëŒ€ì¸ê°„' },
  { emoji: 'ğŸ‘»', name: 'ìœ ë ¹', desc: 'ë– ë„ëŠ” ìœ ë ¹' },
  { emoji: 'ğŸ¤¡', name: 'ê´‘ëŒ€', desc: 'ì›ƒìŒì˜ ê´‘ëŒ€' },
  { emoji: 'ğŸ­', name: 'ë°°ìš°', desc: 'ì—°ê¸°ì˜ ë‹¬ì¸' },
];

// ====== STATE ======
let state = {
  socket: null,
  roomId: null,
  nickname: '',
  avatar: AVATARS[0],
  isHost: false,
  isLiar: false,
  myWord: null,
  myCategory: null,
  currentTurnPlayerId: null,
  myId: null,
  players: [],
  turnOrder: [],
  voteTimerInterval: null,
  voteTimeLeft: 60,
  myVote: null,
  round: 1,
};

// ====== PARTICLES ======
function createParticles() {
  const container = document.getElementById('particles');
  for (let i = 0; i < 15; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const size = Math.random() * 6 + 2;
    const colors = ['#e63946', '#7b2fff', '#06d6a0', '#ffd166'];
    p.style.cssText = `
      width:${size}px; height:${size}px;
      left:${Math.random() * 100}%;
      background:${colors[Math.floor(Math.random()*colors.length)]};
      animation-duration:${Math.random() * 15 + 10}s;
      animation-delay:${Math.random() * 10}s;
    `;
    container.appendChild(p);
  }
}
createParticles();

// ====== SHOW SCREEN ======
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function showOverlay(id) {
  document.getElementById(id).classList.add('active');
}

function hideOverlay(id) {
  document.getElementById(id).classList.remove('active');
}

// ====== TOAST ======
function showToast(msg, duration = 2500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// ====== TITLE SCREEN ======
let selectedAvatar = AVATARS[Math.floor(Math.random() * AVATARS.length)];

function updateAvatarDisplay() {
  const display = document.getElementById('avatarDisplay');
  display.textContent = selectedAvatar.emoji;
  display.classList.remove('animate');
  void display.offsetWidth;
  display.classList.add('animate');
  document.getElementById('avatarName').textContent = selectedAvatar.name;
  document.getElementById('avatarDesc').textContent = selectedAvatar.desc;
}
updateAvatarDisplay();

document.getElementById('randomBtn').addEventListener('click', () => {
  selectedAvatar = AVATARS[Math.floor(Math.random() * AVATARS.length)];
  updateAvatarDisplay();
});

document.getElementById('nicknameInput').addEventListener('input', (e) => {
  document.getElementById('nicknameCount').textContent = e.target.value.length;
});

document.getElementById('createRoomBtn').addEventListener('click', async () => {
  const nickname = document.getElementById('nicknameInput').value.trim();
  if (!nickname) { showToast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
  state.nickname = nickname;
  state.avatar = selectedAvatar;

  try {
    const res = await fetch(`${SERVER_URL}/api/room`, { method: 'POST' });
    const data = await res.json();
    connectAndJoin(data.roomId);
  } catch(e) {
    showToast('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. SERVER_URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    // Demo mode
    connectAndJoin('DEMO' + Math.random().toString(36).slice(2,6).toUpperCase());
  }
});

document.getElementById('joinRoomBtn').addEventListener('click', () => {
  const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
  const nickname = document.getElementById('nicknameInput').value.trim();
  if (!nickname) { showToast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
  if (!code) { showToast('ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
  state.nickname = nickname;
  state.avatar = selectedAvatar;
  connectAndJoin(code);
});

// Check URL params for room join
window.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  const roomId = params.get('room');
  if (roomId) {
    document.getElementById('roomCodeInput').value = roomId;
  }
});

// ====== SOCKET CONNECTION ======
function connectAndJoin(roomId) {
  if (state.socket) state.socket.disconnect();

  const socket = io(SERVER_URL, { transports: ['websocket', 'polling'] });
  state.socket = socket;
  state.roomId = roomId;
  state.myId = null;

  socket.on('connect', () => {
    state.myId = socket.id;
    socket.emit('join_room', {
      roomId,
      nickname: state.nickname,
      avatar: state.avatar
    });
  });

  socket.on('connect_error', () => {
    showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ë°ëª¨ ëª¨ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.');
    runDemoMode();
  });

  socket.on('joined', ({ roomId: rid, isHost }) => {
    state.isHost = isHost;
    setupLobby(rid);
  });

  socket.on('room_update', ({ players, host, state: roomState, currentTurnPlayerId }) => {
    state.players = players;
    state.isHost = host === socket.id;
    updateLobbyPlayers(players, host);

    if (currentTurnPlayerId) {
      state.currentTurnPlayerId = currentTurnPlayerId;
      updateTurnUI();
    }

    if (roomState === 'lobby') {
      // already handled
    }
  });

  socket.on('game_started', ({ isLiar, category, word, turnOrder, currentTurnPlayerId }) => {
    state.isLiar = isLiar;
    state.myWord = word;
    state.myCategory = category;
    state.turnOrder = turnOrder;
    state.currentTurnPlayerId = currentTurnPlayerId;
    state.round = 1;
    state.myVote = null;
    setupGameScreen();
    showScreen('gameScreen');
    hideOverlay('votingOverlay');
    hideOverlay('resultOverlay');
  });

  socket.on('chat_message', (msg) => {
    addChatMessage(msg);
  });

  socket.on('turn_changed', ({ currentTurnPlayerId, round }) => {
    state.currentTurnPlayerId = currentTurnPlayerId;
    state.round = round;
    document.getElementById('roundInfo').textContent = `${round}ë¼ìš´ë“œ`;
    updateTurnUI();
    updateChatInput();
    addSystemMessage(`${getPlayerName(currentTurnPlayerId)}ë‹˜ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤.`);
  });

  socket.on('voting_started', ({ timeLimit }) => {
    showVotingOverlay(timeLimit);
  });

  socket.on('vote_update', ({ voteCount, totalPlayers }) => {
    document.getElementById('voteCountInfo').textContent = `${voteCount}ëª… / ${totalPlayers}ëª… íˆ¬í‘œ ì™„ë£Œ`;
  });

  socket.on('vote_result', (result) => {
    clearVoteTimer();
    hideOverlay('votingOverlay');
    showResultOverlay(result);
  });

  socket.on('vote_skipped', () => {
    // continue playing
  });

  socket.on('returned_to_lobby', () => {
    showScreen('lobbyScreen');
  });

  socket.on('player_left', ({ playerId }) => {
    addSystemMessage(`í”Œë ˆì´ì–´ê°€ ë‚˜ê°”ìŠµë‹ˆë‹¤.`);
    if (state.turnOrder) {
      state.turnOrder = state.turnOrder.filter(p => p.id !== playerId);
    }
  });

  socket.on('error', ({ message }) => {
    showToast('âš ï¸ ' + message);
  });
}

// ====== LOBBY ======
function setupLobby(roomId) {
  const url = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
  document.getElementById('roomIdBadge').textContent = roomId;
  document.getElementById('inviteUrl').textContent = url;
  showScreen('lobbyScreen');
}

function updateLobbyPlayers(players, host) {
  const grid = document.getElementById('playersGrid');
  document.getElementById('playerCountDisplay').textContent = players.length;

  // Update start button
  const startBtn = document.getElementById('startGameBtn');
  const waitingText = document.getElementById('waitingText');
  if (state.isHost) {
    startBtn.style.display = 'block';
    waitingText.style.display = 'none';
    startBtn.disabled = players.length < 3;
    startBtn.textContent = players.length < 3 ? `ìµœì†Œ 3ëª… í•„ìš” (í˜„ì¬ ${players.length}ëª…)` : 'ê²Œì„ ì‹œì‘ ğŸ®';
  } else {
    startBtn.style.display = 'none';
    waitingText.style.display = 'block';
  }

  grid.innerHTML = '';
  players.forEach(p => {
    const card = document.createElement('div');
    card.className = 'player-card' + (p.id === host ? ' host' : '');
    const avatarEmoji = typeof p.avatar === 'object' ? p.avatar.emoji : p.avatar;
    card.innerHTML = `
      <span class="player-avatar-sm">${avatarEmoji}</span>
      <div class="player-name">${escapeHtml(p.nickname)}</div>
      ${p.id === host ? '<span class="host-crown">ğŸ‘‘ ë°©ì¥</span>' : ''}
    `;
    grid.appendChild(card);
  });

  // Empty slots
  for (let i = players.length; i < 8; i++) {
    const slot = document.createElement('div');
    slot.className = 'empty-slot';
    slot.textContent = 'ëŒ€ê¸° ì¤‘...';
    grid.appendChild(slot);
  }
}

document.getElementById('copyBtn').addEventListener('click', () => {
  const url = `${window.location.origin}${window.location.pathname}?room=${state.roomId}`;
  navigator.clipboard.writeText(url).then(() => {
    const btn = document.getElementById('copyBtn');
    btn.textContent = 'âœ“ ë³µì‚¬ë¨';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.textContent = 'ğŸ”— ì´ˆëŒ€ ë§í¬ ë³µì‚¬';
      btn.classList.remove('copied');
    }, 2000);
  });
});

document.getElementById('startGameBtn').addEventListener('click', () => {
  state.socket?.emit('start_game', { roomId: state.roomId });
});

// ====== GAME SCREEN ======
function setupGameScreen() {
  // Role badge
  const badge = document.getElementById('myRoleBadge');
  if (state.isLiar) {
    badge.className = 'my-role-badge liar';
    badge.textContent = 'ë¼ì´ì–´ ğŸ­';
  } else {
    badge.className = 'my-role-badge citizen';
    badge.textContent = 'ì‹œë¯¼ ğŸ‘¤';
  }

  // Topic
  if (state.myWord) {
    document.getElementById('topicWord').textContent = state.myWord;
    document.getElementById('topicWord').style.display = 'block';
    document.getElementById('liarUnknown').style.display = 'none';
    document.getElementById('topicCategory').textContent = state.myCategory;
  } else {
    document.getElementById('topicWord').style.display = 'none';
    document.getElementById('liarUnknown').style.display = 'block';
    document.getElementById('topicCategory').textContent = state.myCategory + ' Â· ë¼ì´ì–´';
  }

  document.getElementById('roundInfo').textContent = '1ë¼ìš´ë“œ';

  // Clear chat
  document.getElementById('chatArea').innerHTML = '<div class="system-message">ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ë¼ì´ì–´ë¥¼ ì°¾ì•„ë¼! ğŸ•µï¸</div>';

  // Turn list
  updateTurnList();
  updateTurnUI();
  updateChatInput();

  // Host actions
  if (state.isHost) {
    document.getElementById('hostActionsCard').style.display = 'block';
    document.getElementById('nonHostActionsCard').style.display = 'none';
  } else {
    document.getElementById('hostActionsCard').style.display = 'none';
    document.getElementById('nonHostActionsCard').style.display = 'block';
  }
}

function updateTurnList() {
  const list = document.getElementById('turnList');
  list.innerHTML = '';
  state.turnOrder.forEach((player, i) => {
    const isCurrent = player.id === state.currentTurnPlayerId;
    const avatarEmoji = typeof player.avatar === 'object' ? player.avatar.emoji : player.avatar;
    const div = document.createElement('div');
    div.className = 'turn-player' + (isCurrent ? ' current' : '');
    div.dataset.playerId = player.id;
    div.innerHTML = `
      <div class="turn-num">${i+1}</div>
      <div class="turn-avatar">${avatarEmoji}</div>
      <div class="turn-name">${escapeHtml(player.nickname)}</div>
      ${isCurrent ? '<div class="turn-indicator">ë°œì–¸ ì¤‘</div>' : ''}
    `;
    list.appendChild(div);
  });
}

function updateTurnUI() {
  document.querySelectorAll('.turn-player').forEach(el => {
    const isCurrent = el.dataset.playerId === state.currentTurnPlayerId;
    el.className = 'turn-player' + (isCurrent ? ' current' : '');
    el.querySelector('.turn-indicator') && el.querySelector('.turn-indicator').remove();
    if (isCurrent) {
      const ind = document.createElement('div');
      ind.className = 'turn-indicator';
      ind.textContent = 'ë°œì–¸ ì¤‘';
      el.appendChild(ind);
    }
  });
}

function updateChatInput() {
  const isMyTurn = state.currentTurnPlayerId === (state.myId || state.socket?.id);
  const input = document.getElementById('chatInput');
  const btn = document.getElementById('sendBtn');
  input.disabled = !isMyTurn;
  btn.disabled = !isMyTurn;
  input.placeholder = isMyTurn ? 'ë‹¨ì–´ë¥¼ ì„¤ëª…í•˜ì„¸ìš”...' : 'ë‹¤ë¥¸ í”Œë ˆì´ì–´ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤...';
  if (isMyTurn) {
    input.focus();
    addSystemMessage('â¬†ï¸ ë‚´ ì°¨ë¡€ì…ë‹ˆë‹¤! ë‹¨ì–´ë¥¼ ì„¤ëª…í•˜ì„¸ìš”.');
  }
}

function addChatMessage(msg) {
  const area = document.getElementById('chatArea');
  const isMe = msg.playerId === (state.myId || state.socket?.id);
  const avatarEmoji = typeof msg.avatar === 'object' ? msg.avatar.emoji : (msg.avatar || 'ğŸ‘¤');
  
  const div = document.createElement('div');
  div.className = 'chat-message' + (isMe ? ' mine' : '');
  div.innerHTML = `
    <div class="chat-avatar">${avatarEmoji}</div>
    <div class="chat-bubble-wrap">
      <div class="chat-sender">${escapeHtml(msg.nickname)}</div>
      <div class="chat-bubble">${escapeHtml(msg.message)}</div>
    </div>
  `;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
}

function addSystemMessage(text) {
  const area = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = 'system-message';
  div.textContent = text;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
}

function getPlayerName(id) {
  const player = state.turnOrder.find(p => p.id === id);
  return player?.nickname || '???';
}

// Send chat
document.getElementById('sendBtn').addEventListener('click', sendChat);
document.getElementById('chatInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendChat();
});

function sendChat() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message) return;
  state.socket?.emit('send_chat', { roomId: state.roomId, message });
  input.value = '';
}

// Vote button
document.getElementById('callVoteBtn').addEventListener('click', () => {
  state.socket?.emit('call_vote', { roomId: state.roomId });
});

document.getElementById('nextRoundBtn').addEventListener('click', () => {
  state.socket?.emit('next_turn', { roomId: state.roomId });
});

// ====== VOTING ======
function showVotingOverlay(timeLimit) {
  state.myVote = null;
  state.voteTimeLeft = timeLimit;

  // Build vote player list
  const container = document.getElementById('votePlayers');
  container.innerHTML = '';
  state.players.forEach(p => {
    if (p.id === (state.myId || state.socket?.id)) return; // can't vote for self
    const avatarEmoji = typeof p.avatar === 'object' ? p.avatar.emoji : (p.avatar || 'ğŸ‘¤');
    const btn = document.createElement('button');
    btn.className = 'vote-player-btn';
    btn.dataset.playerId = p.id;
    btn.innerHTML = `
      <div class="vote-player-avatar">${avatarEmoji}</div>
      <div class="vote-player-name">${escapeHtml(p.nickname)}</div>
    `;
    btn.addEventListener('click', () => submitVote(p.id));
    container.appendChild(btn);
  });

  document.getElementById('voteCountInfo').textContent = '0ëª… íˆ¬í‘œ ì™„ë£Œ';
  document.getElementById('voteTimer').textContent = timeLimit;
  document.getElementById('voteProgressBar').style.width = '100%';

  showOverlay('votingOverlay');
  startVoteTimer(timeLimit);
}

function startVoteTimer(total) {
  clearVoteTimer();
  const timerEl = document.getElementById('voteTimer');
  const barEl = document.getElementById('voteProgressBar');

  state.voteTimerInterval = setInterval(() => {
    state.voteTimeLeft--;
    timerEl.textContent = state.voteTimeLeft;
    barEl.style.width = (state.voteTimeLeft / total * 100) + '%';

    if (state.voteTimeLeft <= 10) {
      timerEl.classList.add('urgent');
    }

    if (state.voteTimeLeft <= 0) {
      clearVoteTimer();
    }
  }, 1000);
}

function clearVoteTimer() {
  clearInterval(state.voteTimerInterval);
  document.getElementById('voteTimer').classList.remove('urgent');
}

function submitVote(targetId) {
  if (state.myVote) return;
  state.myVote = targetId;

  document.querySelectorAll('.vote-player-btn').forEach(btn => {
    btn.classList.add('voted');
    if (btn.dataset.playerId === targetId) btn.classList.add('selected');
  });

  state.socket?.emit('submit_vote', { roomId: state.roomId, targetId });
  showToast('íˆ¬í‘œ ì™„ë£Œ!');
}

// ====== RESULT ======
function showResultOverlay(result) {
  const { eliminated, isLiar, liar, topic } = result;

  const outcomeEl = document.getElementById('resultOutcome');
  const descEl = document.getElementById('resultDesc');

  if (isLiar) {
    outcomeEl.textContent = 'ğŸ‰ ì‹œë¯¼ ìŠ¹ë¦¬!';
    outcomeEl.className = 'result-outcome citizens-win';
    descEl.textContent = `ë¼ì´ì–´ë¥¼ ì¡ì•˜ìŠµë‹ˆë‹¤!`;
  } else {
    outcomeEl.textContent = 'ğŸ­ ë¼ì´ì–´ ìŠ¹ë¦¬!';
    outcomeEl.className = 'result-outcome liar-win';
    descEl.textContent = eliminated 
      ? `${eliminated.nickname}ë‹˜ì€ ë¼ì´ì–´ê°€ ì•„ë‹ˆì—ˆìŠµë‹ˆë‹¤...` 
      : 'íˆ¬í‘œì—ì„œ ì•„ë¬´ë„ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
  }

  if (liar) {
    const liarAvatarEmoji = typeof liar.avatar === 'object' ? liar.avatar.emoji : (liar.avatar || 'ğŸ‘¤');
    document.getElementById('resultLiarAvatar').textContent = liarAvatarEmoji;
    document.getElementById('resultLiarName').textContent = liar.nickname;
  }

  document.getElementById('resultTopicWord').textContent = topic?.word || '-';
  document.getElementById('resultTopicCat').textContent = topic?.category || '-';

  showOverlay('resultOverlay');
}

document.getElementById('returnToLobbyBtn').addEventListener('click', () => {
  if (state.isHost) {
    state.socket?.emit('return_to_lobby', { roomId: state.roomId });
  } else {
    hideOverlay('resultOverlay');
    showScreen('lobbyScreen');
  }
});

// ====== DEMO MODE ======
function runDemoMode() {
  const roomId = state.roomId || 'DEMO0001';
  state.roomId = roomId;
  state.myId = 'me';
  state.isHost = true;

  const demoPlayers = [
    { id: 'me', nickname: state.nickname, avatar: state.avatar },
    { id: 'p2', nickname: 'ì² ìˆ˜', avatar: AVATARS[1] },
    { id: 'p3', nickname: 'ì˜í¬', avatar: AVATARS[2] },
    { id: 'p4', nickname: 'ë¯¼ì¤€', avatar: AVATARS[3] },
  ];
  state.players = demoPlayers;

  setupLobby(roomId);
  updateLobbyPlayers(demoPlayers, 'me');

  document.getElementById('startGameBtn').addEventListener('click', () => {
    const topic = { category: 'ìŒì‹', word: 'í”¼ì' };
    const liarIndex = 1; // p2 is liar
    const turnOrder = [
      { id: 'me', nickname: state.nickname, avatar: state.avatar },
      { id: 'p2', nickname: 'ì² ìˆ˜', avatar: AVATARS[1] },
      { id: 'p3', nickname: 'ì˜í¬', avatar: AVATARS[2] },
      { id: 'p4', nickname: 'ë¯¼ì¤€', avatar: AVATARS[3] },
    ];

    state.isLiar = false;
    state.myWord = 'í”¼ì';
    state.myCategory = 'ìŒì‹';
    state.turnOrder = turnOrder;
    state.currentTurnPlayerId = 'me';
    state.round = 1;
    state.myVote = null;

    setupGameScreen();
    showScreen('gameScreen');

    // Demo: simulate other players
    setTimeout(() => {
      if (state.currentTurnPlayerId !== 'me') return;
    }, 1000);
  }, { once: true });

  // Simulate chat sends in demo
  const origSendChat = sendChat;
  document.getElementById('sendBtn').addEventListener('click', () => {
    // handled by real sendChat which calls socket
  });
}

// ====== UTILS ======
function escapeHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

// ====== INIT ======
// Check URL for room invite
window.addEventListener('load', () => {
  const params = new URLSearchParams(window.location.search);
  const roomParam = params.get('room');
  if (roomParam) {
    document.getElementById('roomCodeInput').value = roomParam;
    showToast('ë°© ì½”ë“œê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
  }
});
</script>
</body>
</html>
